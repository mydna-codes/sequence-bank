os:
  - linux

env:
  - IMAGE_VERSION="latest"

services:
  - docker

language: java
dist: trusty

branches:
  only:
    - master
    - prod

jdk:
  - openjdk13

cache:
  directories:
    - "$HOME/.m2"

install: echo "Skipping installation..."

script:
  - mvn clean package -DskipTests=true
  - docker build -t "$DOCKER_IMAGE_NAME":"$IMAGE_VERSION" .

after_success:
  - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
  - docker push "$DOCKER_IMAGE_NAME"
  - mvn clean deploy -DskipTests=true --settings .ci/settings.xml -P lib

notifications:
  email: false
  slack:
    rooms:
      - "$SLACK_ROOM"
    on_success: always
    on_failure: always
    template:
      - "Repository %{repository_slug} %{result} build (<%{build_url}|#%{build_number}>) for commit (<%{compare_url}|%{commit}>) on branch %{branch}."
      - "Commit author: %{author}"
      - "Commit message: %{commit_message}"
      - "Execution time: %{duration}"
      - "Message: %{message}"